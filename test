#!/bin/bash
PASSED=0
TOTAL=0
BRANCH="$(git name-rev --name-only HEAD)"
echo "running tests for branch $BRANCH"

if [ $BRANCH == "master" ]; then
    let "TOTAL+=1"
    if COVERAGE_FILE=.coverage_processflow coverage run --source=.,lib,jobs --omit="lib/test*","*__init__.py","setup.py" test_processflow.py; then
        echo "main processflow tests passed"
        let "PASSED+=1"
    else
        echo "processflow tests failed"
    fi
fi

tests=("lib/test_setup.py" "lib/test_yearset.py" "lib/test_filemanager.py" "lib/test_util.py" "lib/test_slurm.py" "jobs/test_transfer.py" "lib/test_mailer.py" "jobs/test_ncclimo.py" "jobs/test_timeseries.py" "jobs/test_amwg.py" "lib/test_runmanager.py")

for test in "${tests[@]}" 
do
    let "TOTAL+=1"
    tname=$(python -c "name='${test}';tname=name.split('/')[-1].split('.')[0];print tname")
    echo "--- testing ${tname} ---"
    if COVERAGE_FILE=.coverage_$tname coverage run --source=.,lib,jobs --omit="lib/test*","*__init__.py","setup.py" $test; then
        echo "--- ${tname} passed ---"
        let "PASSED+=1"
    else
        echo "${tname} failed"
    fi
done

coverage combine .coverage_*
coverage report
coverage html
coverage xml

if [ -d /var/www/acme/acme-diags/baldwin32/htmlcov ]; then
    rm -rf /var/www/acme/acme-diags/baldwin32/htmlcov
fi
mv htmlcov /var/www/acme/acme-diags/baldwin32
rm slurm-*

echo $PASSED "out of" $TOTAL "modules passed their tests"

if [ "$PASSED" != "$TOTAL" ]; then
    echo "One or more tests failed"
    exit 1
else
    echo "tests done"
    echo "report available at https://acme-viewer.llnl.gov/baldwin32/htmlcov/"
fi
